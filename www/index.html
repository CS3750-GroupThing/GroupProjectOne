<!DOCTYPE html>
<html>
<head>
<style>
headerl {
	font-size: 2.5em;
}
headerr {
	font-size: 2.5em;
	position: absolute;
	right: 10px;
}
headerc {
	font-size: 1.5em;
}
a {
  color: black;
  text-decoration: none;
}
</style>

<title>Todo list</title>
</head>
<body>

<headerl>Todo List</headerl>&nbsp;&nbsp;<headerc id ="count">(0)</headerc>&nbsp;<headerr><a id="addLink" href=javascript:void(0)' onclick='addTodo();'>&#x2710;</a></headerr>
<hr/>
<table id="todoTable">

</table>
<script type="text/javascript" charset="utf-8" src="js\phonegap.js"></script>
<script type="text/javascript" charset="utf-8">

	/* The local database uses SQL Lite and does not support every commend MySQL supports.  */
	/* Keep this in mind when creating databases on remote end.  Boolean is not supported for example, so I used INTEGER in its place. */
	/*	Casting might be in order or just use the same types in MySQL that we used in the local database. */
	/*	todo_Users has three fields - id INTEGER PRIMARY KEY, username TEXT NOT NULL, password TEXT NOT NULL */
	/*	todo_Items has four fields - id INTEGER PRIMARY KEY, ownerid INTEGER NOT NULL, completed INTEGER NOT NULL, description TEXT NOT NULL */

	/* Initialize database */
	var db = window.openDatabase("Database", "1.0", "todo", 200000);
	db.transaction(populateDB, errorCB, successCB);

	/* Run initial query which in turn calls drawTable */
	db.transaction(queryDB, errorCB);

	// Populate the database 
	// Only used to create the initial local tables.  Create these same tables on whatever MySQL database we use to make it easier to sync.
	function populateDB(tx) {
		tx.executeSql('DROP TABLE IF EXISTS todo_Users');
		/*tx.executeSql('DROP TABLE IF EXISTS todo_Items');*/
		tx.executeSql('CREATE TABLE IF NOT EXISTS todo_Users (id INTEGER PRIMARY KEY, username TEXT NOT NULL, password TEXT NOT NULL)');
		tx.executeSql('CREATE TABLE IF NOT EXISTS todo_Items (id INTEGER PRIMARY KEY, ownerid INTEGER NOT NULL, completed INTEGER NOT NULL, description TEXT NOT NULL)');
		tx.executeSql('INSERT INTO todo_Users (username, password) VALUES ("FirstUser", 1234)');
		tx.executeSql('INSERT INTO todo_Users (username, password) VALUES ("SecondUser", 4321)');
		/*tx.executeSql('INSERT INTO todo_Items (ownerid, completed, description) VALUES ("Aaron", 0, "Mow the lawn")');*/

	}
	function addTodo()
	{
		var todoDesc = prompt("What do you need to do?");
		if (todoDesc != null) {
			db.transaction( function(tx){ addToDB(tx, todoDesc) }, errorCB );
		}
	}
	
	function addToDB(tx, description) {
		var owner = "Aaron";
		tx.executeSql("INSERT INTO todo_Items (ownerid, completed, description) VALUES ('" + owner + "', 0, '" + description + "')");
		db.transaction(queryDB, errorCB);
	}

	function completeToDo(todoID)
	{		
		db.transaction( function(tx){ completeItemInDB(tx, todoID) }, errorCB );
	}
	
	function completeItemInDB(tx, todoID) {
		db.transaction( function(tx){ tx.executeSql("UPDATE todo_Items SET completed=1 WHERE id=" + todoID); }, errorCB );
		db.transaction(queryDB, errorCB);
	}
	
	function uncompleteToDo(todoID)
	{		
		db.transaction( function(tx){ uncompleteItemInDB(tx, todoID) }, errorCB );
	}

	function uncompleteItemInDB(tx, todoID) {
		db.transaction( function(tx){ tx.executeSql("UPDATE todo_Items SET completed=0 WHERE id=" + todoID); }, errorCB );
		db.transaction(queryDB, errorCB);
	}

	function removeTodo(todoID)
	{
		db.transaction( function(tx){ removeItemFromDB(tx, todoID) }, errorCB );
	}

	function removeItemFromDB(tx, todoID) {
		db.transaction( function(tx){ tx.executeSql("DELETE FROM todo_Items WHERE id=" + todoID); }, errorCB );
		db.transaction(queryDB, errorCB);
	}
	
	/* Transaction error callback */
	function errorCB(tx, err) {
		alert("Error processing SQL: " + err);
		console.log("Error processing SQL: " + err);
	}

	/* Transaction success callback */
	function successCB() {
		/*alert("DB Transaction Success!");*/
	}
    
	function queryDB(tx) {
    		tx.executeSql("SELECT * FROM todo_Items ORDER BY id DESC", [], drawTable, errorCB);
	}

	function clearTable()
	{
		var tableHeaderRowCount = 0;
		var table = document.getElementById('todoTable');
		var rowCount = table.rows.length;
		for (var i = tableHeaderRowCount; i < rowCount; i++) {
		    table.deleteRow(tableHeaderRowCount);
		}
	}

	function drawTable(tx, results) {
		var len = results.rows.length;
		clearTable();
		/*alert("Todo item count: " + len);*/
		document.getElementById("count").innerHTML = "(" + len + ")";
		for (var i=0; i<len; i++){
			/*alert("Row = " + i + " ID = " + results.rows.item(i).id + " Owner = " + results.rows.item(i).ownerid + " Completed =  " + results.rows.item(i).completed + " Description =  " + results.rows.item(i).description);*/
	    		var table = document.getElementById("todoTable");
			table.style.width = '100%';
			var header = table.createTHead();
			var row = header.insertRow(0);
			var todoID = results.rows.item(i).id;
			var todoComplete = results.rows.item(i).completed;
			var todoDesc = results.rows.item(i).description;
			var cell0 = row.insertCell(0);
			var cell1 = row.insertCell(1);
			var cell2 = row.insertCell(2);
			cell0.style.borderBottom = "thin solid #d3d3d3";
			cell1.style.borderBottom = "thin solid #d3d3d3";
			cell2.style.borderBottom = "thin solid #d3d3d3";
			cell1.innerHTML = todoDesc;
			cell1.style.fontSize = "24px";
			if (todoComplete == 1)
			{
				cell1.style.setProperty("text-decoration", "line-through");
				cell1.style.setProperty("color", "green");
				cell0.innerHTML = "<a href='javascript:void(0)' onclick='uncompleteToDo(" + todoID + ")'><img src='img\\checkedbox_icon.png'></a>";
			} else {
				cell0.innerHTML = "<a href='javascript:void(0)' onclick='completeToDo(" + todoID + ")'><img src='img\\uncheckedbox_icon.png'></a>";
				cell1.style.setProperty("color", "red");
			}

			cell0.style.width = "50px";
			cell1.style.width = '100%';
			cell1.style.fontSize = "28px";
			cell2.style.width = "50px";

			cell2.innerHTML = "<a href='javascript:void(0)' onclick='removeTodo(" + todoID + ")'><img src='img\\trash_icon.png'></a>";
		}

	}
	
	setInterval(function(){
		/* Code to run every 5 seconds */
		/* Functionality to sync data between the the local database and remote database should go here (or call another function). */
		/* Once the databases are synced, it will redraw the table based on the updated local database by running the following line */
		db.transaction(queryDB, errorCB);
	}, 5000);
    </script>
</body>
</html> 